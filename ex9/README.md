# バイナリファイルの読み方

ときとしてバイナリファイルを読んで、数値を取り出す
必要がある。ここでは、xxdコマンドを使ってバイナリファイルを
作り、作ったファイルをpythonスクリプトで読んで数値を
取り出してみる。

## バイナリファイルの作り方

いろいろあると思うがここではxxdコマンドを使って作ってみる。
まず元とあるデータを16進で作る:

```console
% cat data.txt
00 00 00 01 00 00 00 02
00 00 00 03 00 00 00 04
00 00 00 0a 00 00 00 0b
41 42 43 44 77 78 79 7a
```

これをxxdコマンドでバイナリファイルに変換する:

```console
% xxd -r -p data.txt > data.bin
% file data.bin
data.bin: data
```

fileコマンドは指定したファイルのタイプ(実行ファイル、Pythonスクリプトファイル等)
を出力するコマンド。タイプが不明な場合はdataと出力される。

## バイナリファイルの表示

バイナリファイルをcatするときには``cat -v``のように``-v``オプションを付けると
ターミナルが乱れることがない。

% cat -v data.bin
^@^@^@^A^@^@^@^B^@^@^@^C^@^@^@^D^@^@^@
^@^@^@^KABCDwxyz
```

hexdumpコマンドを使うこともある。-Cを付けると
ascii文字列として表示可能な文字が表示される:
```console
% hexdump -C data.bin
00000000  00 00 00 01 00 00 00 02  00 00 00 03 00 00 00 04  |................|
00000010  00 00 00 0a 00 00 00 0b  41 42 43 44 77 78 79 7a  |........ABCDwxyz|
00000020
```

cat、hexdumpの他にもxxdコマンドが使える。

```console
% xxd data.bin
00000000: 0000 0001 0000 0002 0000 0003 0000 0004  ................
00000010: 0000 000a 0000 000b 4142 4344 7778 797a  ........ABCDwxyz
```

たとえば以下のようなデータフォーマット表があり、
これと照し合せて表示されたい場合はxxdコマンドが便利。

```
0                31
+-----------------+
|    header0 (4)  |
+-----------------+
|    header1 (4)  |
+-----------------+
(以下略)
```

```console
% xxd -g 1 -c 4 data.bin
00000000: 00 00 00 01  ....
00000004: 00 00 00 02  ....
00000008: 00 00 00 03  ....
0000000c: 00 00 00 04  ....
00000010: 00 00 00 0a  ....
00000014: 00 00 00 0b  ....
00000018: 41 42 43 44  ABCD
0000001c: 77 78 79 7a  wxyz
%
```

16進数ではなくて0、1のビットとして表示したい場合は``-b``オプションを
使う:
```console
hspc02% xxd -b -g 1 -c 4 data.bin                                               ~/doc/kenshu/ex9
00000000: 00000000 00000000 00000000 00000001  ....
00000004: 00000000 00000000 00000000 00000010  ....
00000008: 00000000 00000000 00000000 00000011  ....
0000000c: 00000000 00000000 00000000 00000100  ....
00000010: 00000000 00000000 00000000 00001010  ....
00000014: 00000000 00000000 00000000 00001011  ....
00000018: 01000001 01000010 01000011 01000100  ABCD
0000001c: 01110111 01111000 01111001 01111010  wxyz
```

(注)
hexdumpでも出力フォーマットファイルを書けば1行4バイトという
表示ができるがxxdのほうが手軽。

```console
% cat 4bytes.fmt
"%06.6_ao " 4/1 "%02x "
"\t" "%_p"
"\n"
% hexdump -f 4bytes.fmt data.bin
000000 00 00 00 01	....
000004 00 00 00 02	....
000010 00 00 00 03	....
000014 00 00 00 04	....
000020 00 00 00 0a	....
000024 00 00 00 0b	....
000030 41 42 43 44	ABCD
000034 77 78 79 7a	wxyz
```

## pythonプログラムでバイナリファイルを読む

- open(filename, 'rb')と第2引数に``b``を追加してバイナリファイルとしてオープンすることを明示する。
- f.read(n)とするとnバイト読む。
- ファイル終端に達するとread()は``b''``(バイナリ文字列としての空文字)をかえす。
- structモジュールを使ってバイナリから数値に変換する。ここでは4バイト整数として解釈することにして``>I``を第1引数に指定している。

## 複数バイトを使った整数表現について

複数バイトを使って数値を表現する場合

- 最初のバイトが一番大きい桁を表す
- 最後のバイトが一番小さい桁を表す

のふたつの流儀があるので、どちらの流儀なのかは仕様、あるいは
バイナリファイル作成者に確認する必要がある。


