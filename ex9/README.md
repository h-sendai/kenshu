# バイナリファイルの読み方

ときとしてバイナリファイルを読んで、数値を取り出す
必要がある。ここでは、xxdコマンドを使ってバイナリファイルを
作り、作ったファイルをpythonスクリプトで読んで数値を
取り出してみる。

## バイナリファイルの作り方

いろいろあると思うがここではxxdコマンドを使って作ってみる。
まず元とあるデータを16進で作る:

```console
% cat data.txt
00 10 00 00 00 00 00 10
00 00 00 ff 01 00 02 00
03 00 04 00 00 41 42 43
44 45 45 46
```

これをxxdコマンドでバイナリファイルに変換する:

```console
% xxd -r -p data.txt > data.bin

% ls -l data.txt; ls -l  data.bin
-rw-rw-r--. 1 you you 84 Jun  2 16:01 data.txt
-rw-rw-r--. 1 you you 28 Jun  2 16:01 data.bin
% file data.bin
data.bin: GLS_BINARY_MSB_FIRST
```

fileコマンドは指定したファイルのタイプ(実行ファイル、Pythonスクリプトファイル等)
を出力するコマンド。ここではGLS_BINARY_MSB_FIRSTと判定されている
(これがなにかは知らない)。タイプが不明な場合はdataと出力される。

## バイナリファイルの表示

バイナリファイルをcatするときには``cat -v``のように``-v``オプションを付けると
ターミナルが乱れることがない。

```console
% cat -v data.bin
^@^P^@^@^@^@^@^P^@^@^@M-^?^A^@^B^@^C^@^D^@^@ABCDEEF
```

hexdumpコマンドを使うこともある。-Cを付けると
ascii文字列として表示可能な文字が表示される:
```console
% hexdump -C data.bin
00000000  00 10 00 00 00 00 00 10  00 00 00 ff 01 00 02 00  |................|
00000010  03 00 04 00 00 41 42 43  44 45 45 46              |.....ABCDEEF|
0000001c
```

cat、hexdumpの他にもxxdコマンドが使える。

```console
% xxd data.bin
00000000: 0010 0000 0000 0010 0000 00ff 0100 0200  ................
00000010: 0300 0400 0041 4243 4445 4546            .....ABCDEEF
```

たとえば以下のようなデータフォーマット表があり、
これと照し合せて表示されたい場合はxxdコマンドが便利。

```
31                              0
+-------+-------+-------+-------+
|    # of Ch    |  0x00 |  0x00 |
+-------+-------+-------+-------+
| Data Length                   |
+-------+-------+-------+-------+
| Trigger Count                 |
+-------+-------+-------+-------+
|   Ch 0        |    Ch 1       |
+-------+-------+-------+-------+
|   Ch 2        |    Ch 3       |
+-------+-------+-------+-------+
(以下略)
```

```console
% xxd -g 1 -c 4 data.bin
00000000: 00 10 00 00  ....
00000004: 00 00 00 10  ....
00000008: 00 00 00 ff  ....
0000000c: 01 00 02 00  ....
00000010: 03 00 04 00  ....
00000014: 00 41 42 43  .ABC
00000018: 44 45 45 46  DEEF
%
```

16進数ではなくて0、1のビットとして表示したい場合は``-b``オプションを
使う:
```console
% xxd -b -g 1 -c 4 data.bin
00000000: 00000000 00010000 00000000 00000000  ....
00000004: 00000000 00000000 00000000 00010000  ....
00000008: 00000000 00000000 00000000 11111111  ....
0000000c: 00000001 00000000 00000010 00000000  ....
00000010: 00000011 00000000 00000100 00000000  ....
00000014: 00000000 01000001 01000010 01000011  .ABC
00000018: 01000100 01000101 01000101 01000110  DEEF
```

(注)
hexdumpでも出力フォーマットファイルを書けば1行4バイトという
表示ができるがxxdのほうが手軽。

```console
% cat 4bytes.fmt
"%06.6_ao " 4/1 "%02x "
"\t" "%_p"
"\n"
% hexdump -f 4bytes.fmt data.bin
000000 00 10 00 00	....
000004 00 00 00 10	....
000010 00 00 00 ff	....
000014 01 00 02 00	....
000020 03 00 04 00	....
000024 00 41 42 43	.ABC
000030 44 45 45 46	DEEF
```

## pythonプログラムでバイナリファイルを読む

- open(filename, 'rb')と第2引数に``b``を追加してバイナリファイルとしてオープンすることを明示する。
- f.read(n)とするとnバイト読む。
- ファイル終端に達するとread()は``b''``(バイナリ文字列としての空文字)をかえす。
- structモジュールを使ってバイナリから数値に変換する。ここでは4バイト整数として解釈することにして``>I``を第1引数に指定している。

## 複数バイトを使った整数表現について

複数バイトを使って数値を表現する場合

- 最初のバイトが一番大きい桁を表す
- 最初のバイトが一番小さい桁を表す

のふたつの流儀があるので、どちらの流儀なのかは仕様、あるいは
バイナリファイル作成者に確認する必要がある。


